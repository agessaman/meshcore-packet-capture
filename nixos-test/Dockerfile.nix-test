FROM ubuntu:22.04

# Install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    xz-utils \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Create nixbld group and user for Nix installation
RUN groupadd -r nixbld && \
    for i in $(seq 1 32); do useradd -r -g nixbld -G nixbld -d /var/empty -s /sbin/nologin -c "Nix build user $i" nixbld$i 2>/dev/null || true; done

# Install Nix (single-user mode for Docker)
RUN mkdir -m 0755 -p /nix && \
    curl -L https://nixos.org/nix/install | sh -s -- --no-daemon

# Enable flakes
RUN mkdir -p /root/.config/nix && \
    echo "experimental-features = nix-command flakes" >> /root/.config/nix/nix.conf

# Set up environment
ENV PATH="/root/.nix-profile/bin:/nix/var/nix/profiles/default/bin:$PATH"

WORKDIR /workspace

CMD ["/bin/bash"]

